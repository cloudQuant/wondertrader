# threadpool::size_policies 优化建议

## 概述

本文档针对 `wondertrader/src/Share/threadpool/size_policies.hpp` 文件提出优化建议和改进方向。该文件实现了线程池的大小策略，用于控制线程池中工作线程的数量。

## 代码问题修复

### 1. 未实现的功能完善

- 当前文件中 `static_size` 类的 `task_scheduled()` 和 `task_finished()` 方法被标记为 TODO，但尚未实现。
- 建议完善这些方法，使其能够根据任务负载动态调整线程池大小，例如当任务队列中的任务数量超过某个阈值时增加线程数，当任务完成后减少空闲线程。

### 2. 异常处理机制

- 当前的大小策略没有包含异常处理机制。如果线程创建失败或者其他操作抛出异常，代码没有适当的处理方式。
- 建议在 `resize` 等关键方法中添加异常处理，确保即使在异常情况下线程池也能够保持稳定状态。

### 3. 线程安全性问题

- 虽然 `static_size` 类的 `m_pool` 成员变量使用了 `volatile` 限定符，但这不足以保证线程安全。
- 建议使用适当的同步机制（如互斥锁）保护对共享资源的访问，尤其是在 `resize` 和 `worker_died_unexpectedly` 方法中。

## 功能优化建议

### 1. 自适应大小策略

- 当前的 `static_size` 策略非常基础，仅在线程意外死亡时补充新线程。
- 建议实现一个自适应大小策略，能够根据以下因素动态调整线程数：
  - 任务队列长度
  - CPU 利用率
  - 任务执行时间统计
  - 系统负载

```cpp
template<typename Pool>
class adaptive_size
{
public:
  void task_scheduled() 
  {
    // 检查任务队列长度，必要时增加线程
    if(pending_tasks > thread_count * 2 && thread_count < max_threads)
    {
      m_pool.get().resize(thread_count + 1);
    }
  }
  
  void task_finished() 
  {
    // 检查空闲线程数，必要时减少线程
    if(idle_threads > thread_count / 4 && thread_count > min_threads)
    {
      m_pool.get().resize(thread_count - 1);
    }
  }
};
```

### 2. 基于优先级的大小策略

- 当前所有线程都被同等对待，没有考虑任务的优先级。
- 建议实现优先级感知的大小策略，为高优先级任务保留专用线程，或者在高优先级任务到来时快速增加线程数量。

### 3. 分层线程池策略

- 当前策略只控制单个线程池的大小。
- 考虑实现分层线程池策略，将任务分配到不同的线程池层，每层有不同的大小策略：
  - 核心层：常驻线程，处理关键任务
  - 弹性层：根据负载动态调整大小
  - 溢出层：只在高负载时临时创建

## 性能优化建议

### 1. 线程预热机制

- 当前线程是按需创建的，可能导致线程创建的延迟。
- 建议实现线程预热机制，在预期任务增加前提前创建线程，减少线程创建的延迟。

```cpp
void preheat(size_t expected_load)
{
  // 预估即将到来的负载，提前创建足够的线程
  size_t needed_threads = std::min(max_threads, 
                         current_threads + expected_load / tasks_per_thread);
  m_pool.get().resize(needed_threads);
}
```

### 2. 批量线程管理

- 当前的 `resize` 方法每次调整可能只改变一个线程，而频繁的线程创建和销毁可能影响性能。
- 建议实现批量线程管理策略，一次性创建或销毁多个线程，减少开销。

### 3. 线程复用

- 当前策略可能频繁创建和销毁线程，造成资源浪费。
- 考虑实现线程复用机制，将空闲线程放入休眠状态而非销毁，需要时快速唤醒，减少线程创建的开销。

## 可用性与接口优化

### 1. 配置接口增强

- 当前策略的配置选项有限（基本上只有工作线程数量）。
- 建议增加更多配置选项，如：
  - 最小/最大线程数
  - 线程空闲超时时间
  - 任务队列阈值
  - 线程创建速率限制

### 2. 监控与统计接口

- 当前策略缺乏监控和统计能力。
- 建议添加以下接口：
  - 获取当前活动线程数
  - 获取空闲线程数
  - 获取线程利用率统计
  - 线程创建/销毁频率统计

### 3. 事件通知机制

- 当前策略没有提供事件通知机制。
- 建议实现回调机制，在以下事件发生时通知用户：
  - 线程池大小变化
  - 线程意外死亡
  - 线程池达到容量上限
  - 性能警告（如线程创建过于频繁）

## 兼容性与可维护性

### 1. 现代 C++ 特性支持

- 当前实现未充分利用现代 C++ 特性。
- 建议利用 C++11/14/17 的特性，如：
  - 使用 `std::function` 替代函数指针
  - 使用 `std::atomic` 进行线程安全的计数操作
  - 使用 `std::chrono` 处理时间相关操作

### 2. 文档完善

- 代码中有一些 TODO 注释，但没有详细说明。
- 建议完善文档，特别是：
  - 补充各个策略的使用场景和选择指南
  - 添加性能特性和限制说明
  - 提供调优参数的最佳实践

### 3. 单元测试

- 大小策略缺乏足够的单元测试。
- 建议为每个策略添加单元测试，尤其是测试：
  - 极端情况（线程数为0，线程数达到系统最大值）
  - 高频率调整大小的性能和稳定性
  - 多线程并发调用 resize 的行为

## 总结

`size_policies.hpp` 文件提供了基本的线程池大小调整策略，但在功能完整性、性能优化和用户友好性方面还有提升空间。建议重点完善自适应大小策略，增加线程安全保障，并提供更丰富的配置和监控接口，使线程池能够更智能地适应不同的工作负载。

特别地，完成 `task_scheduled()` 和 `task_finished()` 方法的实现是当前最迫切的任务，这将显著提高线程池在变化负载下的适应能力。
