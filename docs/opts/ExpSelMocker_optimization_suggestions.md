# ExpSelMocker类优化建议

本文档记录了对ExpSelMocker类的代码审查过程中发现的可能优化点。这些建议旨在提高代码的可读性、维护性、性能和稳定性，但不改变现有功能和接口。

## 一、错误处理优化

1. **增强空指针检查**
   - 在`on_tick_updated`函数中已有对`_tick_subs`的检查，但其他回调函数可能也需要类似的防御性检查
   - 建议在`on_bar_close`等函数中增加对输入参数的非空检查，例如：
   ```cpp
   if (stdCode == nullptr || period == nullptr || newBar == nullptr)
       return;
   ```

2. **异常捕获处理**
   - 当前所有外部回调函数(getRunner()调用)都没有异常处理逻辑
   - 建议添加try-catch块捕获可能的异常，防止异常传播到外部导致程序崩溃：
   ```cpp
   try {
       getRunner().ctx_on_bar(_context_id, stdCode, period, newBar, ET_SEL);
   } catch (const std::exception& e) {
       // 记录错误日志或采取适当的恢复措施
   }
   ```

## 二、性能优化

1. **避免不必要的回调**
   - 目前`on_strategy_schedule`函数中同时调用了上下文级事件回调和全局事件回调，可能导致重复计算
   - 考虑根据具体需求选择性地调用回调函数，减少不必要的事件传播

2. **使用移动语义优化**
   - 在处理大量数据时，可以考虑使用C++11的移动语义减少数据复制开销
   - 例如在传递大型数据结构时，使用std::move减少复制开销

## 三、代码结构优化

1. **统一回调处理模式**
   - 不同的回调函数有不同的处理模式，有些调用父类后再回调外部，有些直接回调外部
   - 建议统一模式：先调用父类处理 -> 执行额外逻辑 -> 回调外部

2. **抽象共通回调逻辑**
   - 多个回调函数中都有调用`getRunner()`的相似代码模式
   - 可以考虑将通用的回调逻辑抽象成私有辅助函数，减少代码重复

## 四、可维护性优化

1. **添加断言验证**
   - 在关键函数的开始部分添加断言(assert)检查输入参数的有效性，这有助于在开发调试阶段捕获问题
   ```cpp
   assert(stdCode != nullptr && "stdCode cannot be null");
   ```

2. **增加详细日志**
   - 在关键操作或可能出现问题的地方添加调试日志
   - 这对于排查回测过程中的问题特别有帮助

## 五、接口一致性优化

1. **命名一致性**
   - `on_bactest_end()`函数名与头文件中声明的`on_bactest_end()`有拼写不一致的风险
   - 建议检查所有函数命名确保与基类保持一致

2. **参数传递优化**
   - 考虑对大型对象使用const引用传递而非指针传递，提高代码安全性和可读性
   - 例如将`WTSBarStruct* newBar`改为`const WTSBarStruct& newBar`

## 六、内存管理优化

1. **引用计数管理**
   - 检查是否所有通过回调传递的对象都正确管理了引用计数
   - 确保没有内存泄漏，尤其是在大规模回测时可能消耗大量内存

2. **智能指针使用**
   - 考虑使用智能指针替代原始指针，特别是在类成员变量中
   - 例如使用`std::shared_ptr<HisDataReplayer>`代替`HisDataReplayer*`

以上建议可以根据实际项目需求和代码风格进行选择性采纳，目的是在不破坏现有功能的前提下提高代码质量。
